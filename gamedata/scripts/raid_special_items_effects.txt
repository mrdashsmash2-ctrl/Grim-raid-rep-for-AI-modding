local HI = has_alife_info
local GI = give_info
local DI = disable_info

local injector_ar = {
	[1] = { "flesh_s", "boar_s" },
	[2] = { "dog_s", "SM_LURKER" },
	[3] = { "pseudodog_s", "dog_s", "SM_LURKER", "flesh_s", "boar_s" },
	[4] = { "bloodsucker_s", "pseudodog_s", "psy_dog_s" },
	[5] = { "flesh_s", "boar_s", "dog_s", "SM_LURKER", "pseudodog_s", "bloodsucker_s", "psy_dog_s", "chimera_s" },
}

function actor_on_item_use(item)
	if string.find(item:section(), "raid_injector_") and level.name() ~= raid_utils.raid_home_level then
		GI("raid_special_item_" .. item:section())
	end
end

function npc_on_before_hit(npc, s_hit, bone_id, flags)
	if not (s_hit.weapon_id and s_hit.draftsman and s_hit.draftsman:id() == 0) then return end

	local wpn = level.object_by_id(s_hit.weapon_id)
	if not wpn then return end

	local ammo_type = wpn:get_ammo_type()
	local ammo_list = utils_item.get_ammo(wpn:section(), wpn:id())
	local ammo_sec = ammo_list and ammo_type and ammo_list[ammo_type + 1]
	if not (ammo_sec and ammo_sec == "ammo_12x70_raid") then return end

	s_hit.power = s_hit.power * 20
end

function on_enemy_eval(obj, enemy, flags)
	if not (IsMonster(obj) and enemy:id() == 0) then return end

	if check_enemy_ignore(obj) then
		flags.override = true
		flags.result = false
	end
end

function check_enemy_ignore(obj)
	for i = 1, #injector_ar do
		if HI("raid_special_item_" .. i) then
			for j = 1, #injector_ar[i] do
				local obj_cls = injector_ar[i][j]
				local obj_kind = ini_sys:r_string_ex(obj:section(), "kind") or "null"
				if obj:clsid() == clsid[obj_cls] or obj_kind == obj_cls then
					return true
				end
			end
		end
	end
end


----------------------------------

function remove_special_items_info_portions()
	-- remove special items info portions
	local function itr(id, info)
		if string.find(info, "raid_special_item_") then
			DI(info)
		end
	end
	alife():iterate_info(0, itr)

	-- and remove pill
	if raid_main.actor_not_died then
		local pill = db.actor:object("pill_raid")
		if pill then
			alife_release(pill)
		end
	end
end

function on_game_start()
	RegisterScriptCallback("actor_on_item_use", actor_on_item_use)
	RegisterScriptCallback("npc_on_before_hit", npc_on_before_hit)
	RegisterScriptCallback("monster_on_before_hit", npc_on_before_hit)
	RegisterScriptCallback("on_enemy_eval", on_enemy_eval)
end