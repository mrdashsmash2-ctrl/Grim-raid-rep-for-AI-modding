local gt = game.translate_string
local ltx = ini_file("misc\\task\\tm_raid_tasks.ltx")
local ctime_to_t = utils_data.CTime_to_table
local t_to_ctime = utils_data.CTime_from_table


-- ============================================
-- ================ (1) Kill Stalker =================
-- ============================================
task_functor.raid_task_kill_stalker_target_functor = function(task_id,field,p,tsk)
	local active_t = raid_tasks_main.raid_active_tasks
	local stage = tsk and tsk.stage

	if (field == "title") then
		return raid_utils.get_raid_task_title(task_id, stage, 3)
	elseif (field == "descr") then
		return raid_utils.get_raid_task_descr(task_id, stage, 3)
	elseif (field == "target") and stage and stage > 0 and active_t[task_id] then
		if stage == 2 then
			local se_obj = alife_object(active_t[task_id].stalker_id)
			return se_obj and se_obj.alive and se_obj:alive() and se_obj.id
		end
	end

end

task_status_functor.raid_task_kill_stalker_status_functor = function(tsk,task_id)
	local active_t = raid_tasks_main.raid_active_tasks
	local cur_time = game.get_game_time()
	local task_data = raid_tasks_main.get_task_data(task_id)
	if not (task_data and tsk) then return end

	if not tsk.stage then
		tsk.stage = 0
	end

	if tsk.stage > 0 and not active_t[task_id] then
		return
	end

--[[
	0 = setup
	1 = spawn
	2 = watch when killed
	3 = killed
--]]

	-- setup
	if tsk.stage == 0 then
		active_t[task_id] = {}

		-- store level name
		active_t[task_id].level_name = task_data.level_name

		-- get squad section
		local sec = task_data.kill_stalker_squad_sec
		active_t[task_id].squad_sec = sec

		-- store non-busy and viable smart id
		local all_smarts_t = raid_utils.find_random_smart(task_data.level_name, true, "all")
		local comm = ini_sys:r_string_ex(sec, "faction")
		local smart = raid_utils.find_viable_smart(all_smarts_t, comm)
		local smart_id = smart.id
		active_t[task_id].smart_id = smart_id

		-- add smart id to busy smarts
		raid_tasks_main.raid_busy_smarts_t[smart_id] = true

		-- killed_by field
		active_t[task_id].killed_by_actor = false

		-- set timer
		active_t[task_id].start_time = ctime_to_t(cur_time)

		tsk.stage = 1
		return
	end


	-- spawn
	if tsk.stage == 1 and level.name() == active_t[task_id].level_name then
		local squad = raid_simulation.spawn_raid_sim_squad(active_t[task_id].smart_id, active_t[task_id].squad_sec)

		-- store commander id as a target and squad id for release
		if squad and squad.commander_id and squad:commander_id() then
			active_t[task_id].squad_id = squad.id
			active_t[task_id].stalker_id = squad:commander_id()
			active_t[task_id].stalker_killed = false
		end

		tsk.stage = 2
		return
	end


	-- if killed by someone else
	if tsk.stage == 2 and active_t[task_id].stalker_killed and (not active_t[task_id].killed_by_actor) then
		raid_tasks_main.end_raid_task(task_id, "cancel")
		return
	end

	-- if killed by us
	if tsk.stage == 2 and active_t[task_id].killed_by_actor then
		tsk.stage = 3
	end

	-- fail on return without killing
	if tsk.stage == 2 and level.name() == raid_utils.raid_home_level then
		raid_tasks_main.end_raid_task(task_id, "fail")
		return
	end

	-- complete
	if tsk.stage == 3 then
		if level.name() == raid_utils.raid_home_level then
			raid_tasks_main.end_raid_task(task_id, "complete")
		end
		return
	end

	-- fail on timer
	if task_data.urgent < 4 then
		local hours = raid_tables.raid_urgency_time[task_data.urgent]
		if cur_time:diffSec(t_to_ctime(active_t[task_id].start_time)) > (hours * 3600) then
			raid_tasks_main.end_raid_task(task_id, "fail")
			return
		end
	end

end


-- ============================================
-- ============== (2) Kill Stalker squad ===============
-- ============================================
task_functor.raid_task_kill_stalker_squad_target_functor = function(task_id,field,p,tsk)
	local active_t = raid_tasks_main.raid_active_tasks
	local stage = tsk and tsk.stage

	if (field == "title") then
		return raid_utils.get_raid_task_title(task_id, stage, 3)
	elseif (field == "descr") then
		return raid_utils.get_raid_task_descr(task_id, stage, 3)
	elseif (field == "target") and stage and stage > 0 and active_t[task_id] then
		if tsk.stage == 2 then
			local squad = alife_object(active_t[task_id].stalker_squad_id)
			if squad and squad.commander_id then
				return squad:commander_id()
			end
		end
	end

end

task_status_functor.raid_task_kill_stalker_squad_status_functor = function(tsk,task_id)
	local active_t = raid_tasks_main.raid_active_tasks
	local cur_time = game.get_game_time()
	local task_data = raid_tasks_main.get_task_data(task_id)
	if not (task_data and tsk) then return end

	if not tsk.stage then
		tsk.stage = 0
	end

	if tsk.stage > 0 and not active_t[task_id] then
		return
	end

--[[
	0 = setup
	1 = spawn
	2 = watch when killed
	3 = all killed
--]]

	-- setup
	if tsk.stage == 0 then
		active_t[task_id] = {}

		-- store level name
		active_t[task_id].level_name = task_data.level_name

		-- get squad section
		local sec = task_data.kill_stalker_squad_sec
		active_t[task_id].squad_sec = sec

		-- store non-busy and viable smart id
		local all_smarts_t = raid_utils.find_random_smart(task_data.level_name, true, "all")
		local comm = ini_sys:r_string_ex(sec, "faction")
		local smart = raid_utils.find_viable_smart(all_smarts_t, comm)
		local smart_id = smart.id
		active_t[task_id].smart_id = smart_id

		-- add smart id to busy smarts
		raid_tasks_main.raid_busy_smarts_t[smart_id] = true

		-- killed_by field
		active_t[task_id].killed = 0
		active_t[task_id].killed_by_actor = 0

		-- set timer
		active_t[task_id].start_time = ctime_to_t(cur_time)

		tsk.stage = 1
		return
	end


	-- spawn
	if tsk.stage == 1 and level.name() == active_t[task_id].level_name then
		local squad = raid_simulation.spawn_raid_sim_squad(active_t[task_id].smart_id, active_t[task_id].squad_sec)

		-- store squad id as a target and squad size
		if squad and squad.commander_id then
			active_t[task_id].stalker_squad_id = squad.id
			active_t[task_id].squad_size = raid_utils.get_squad_size(squad.id)
		end

		tsk.stage = 2
		return
	end


	-- if all killed
	if tsk.stage == 2 and active_t[task_id].killed >= active_t[task_id].squad_size then
		-- if enough killed by us
		if active_t[task_id].killed_by_actor >= (active_t[task_id].squad_size * 0.6) then
			tsk.stage = 3
			return
		end

		-- not enough killed
		raid_tasks_main.end_raid_task(task_id, "cancel")
		return
	end


	-- return home with enough killed
	if tsk.stage == 3 then
		if level.name() == raid_utils.raid_home_level then
			raid_tasks_main.end_raid_task(task_id, "complete")
		end
		return
	end

	-- return home with not enough killed
	if tsk.stage == 2 and level.name() == raid_utils.raid_home_level then
		raid_tasks_main.end_raid_task(task_id, "fail")		-- xcvb reward argument here
		return
	end

	-- fail on timer
	if task_data.urgent < 4 then
		local hours = raid_tables.raid_urgency_time[task_data.urgent]
		if cur_time:diffSec(t_to_ctime(active_t[task_id].start_time)) > (hours * 3600) then
			raid_tasks_main.end_raid_task(task_id, "fail")
		end
	end

end


-- ============================================
-- ============== (3) Kill Mutant squad ===============
-- ============================================
task_functor.raid_task_kill_mutant_squad_target_functor = function(task_id,field,p,tsk)
	local active_t = raid_tasks_main.raid_active_tasks
	local stage = tsk and tsk.stage

	if (field == "title") then
		return raid_utils.get_raid_task_title(task_id, stage, 3)
	elseif (field == "descr") then
		return raid_utils.get_raid_task_descr(task_id, stage, 3)
	elseif (field == "target") and stage and stage > 0 and active_t[task_id] then
		if tsk.stage == 2 then
			local squad = alife_object(active_t[task_id].mutant_squad_id)
			if squad and squad.commander_id then
				return squad:commander_id()
			end
		end
	end

end

task_status_functor.raid_task_kill_mutant_squad_status_functor = function(tsk,task_id)
	local active_t = raid_tasks_main.raid_active_tasks
	local cur_time = game.get_game_time()
	local task_data = raid_tasks_main.get_task_data(task_id)
	if not (task_data and tsk) then return end

	if not tsk.stage then
		tsk.stage = 0
	end

	if tsk.stage > 0 and not active_t[task_id] then
		return
	end

--[[
	0 = setup
	1 = spawn
	2 = watch when killed
	3 = all killed
--]]

	-- setup
	if tsk.stage == 0 then
		active_t[task_id] = {}

		-- store level name
		active_t[task_id].level_name = task_data.level_name

		-- get squad section
		local sec = task_data.kill_mutant_squad_sec
		active_t[task_id].squad_sec = sec

		-- store non-busy and viable smart id
		local all_smarts_t = raid_utils.find_random_smart(task_data.level_name, true, "all")
		local smart = raid_utils.find_viable_smart(all_smarts_t, "monster")
		local smart_id = smart.id
		active_t[task_id].smart_id = smart_id

		-- add smart id to busy smarts
		raid_tasks_main.raid_busy_smarts_t[smart_id] = true

		-- killed_by field
		active_t[task_id].killed = 0
		active_t[task_id].killed_by_actor = 0

		-- set timer
		active_t[task_id].start_time = ctime_to_t(cur_time)

		tsk.stage = 1
		return
	end


	-- spawn
	if tsk.stage == 1 and level.name() == active_t[task_id].level_name then
		local squad = raid_simulation.spawn_raid_sim_squad(active_t[task_id].smart_id, active_t[task_id].squad_sec)

		-- store squad id as a target and squad size
		if squad and squad.commander_id then
			active_t[task_id].mutant_squad_id = squad.id
			active_t[task_id].squad_size = raid_utils.get_squad_size(squad.id)
		end

		tsk.stage = 2
		return
	end


	-- if all killed
	if tsk.stage == 2 and active_t[task_id].killed >= active_t[task_id].squad_size then
		-- if enough killed by us
		if active_t[task_id].killed_by_actor >= (active_t[task_id].squad_size * 0.6) then
			tsk.stage = 3
			return
		end

		-- not enough killed
		raid_tasks_main.end_raid_task(task_id, "cancel")
		return
	end


	-- return home with enough killed
	if tsk.stage == 3 then
		if level.name() == raid_utils.raid_home_level then
			raid_tasks_main.end_raid_task(task_id, "complete")
		end
		return
	end

	-- return home with not enough killed
	if tsk.stage == 2 and level.name() == raid_utils.raid_home_level then
		raid_tasks_main.end_raid_task(task_id, "fail")		-- xcvb reward argument here
		return
	end

	-- fail on timer
	if task_data.urgent < 4 then
		local hours = raid_tables.raid_urgency_time[task_data.urgent]
		if cur_time:diffSec(t_to_ctime(active_t[task_id].start_time)) > (hours * 3600) then
			raid_tasks_main.end_raid_task(task_id, "fail")
		end
	end

end


-- ============================================
-- =========== (4) Kill Strong Stalker squad =============
-- ============================================
task_functor.raid_task_kill_strong_stalker_squad_target_functor = function(task_id,field,p,tsk)
	local active_t = raid_tasks_main.raid_active_tasks
	local stage = tsk and tsk.stage

	if (field == "title") then
		return raid_utils.get_raid_task_title(task_id, stage, 3)
	elseif (field == "descr") then
		return raid_utils.get_raid_task_descr(task_id, stage, 3)
	elseif (field == "target") and stage and stage > 0 and active_t[task_id] then
		if tsk.stage == 2 then
			local squad = alife_object(active_t[task_id].strong_stalker_squad_id)
			if squad and squad.commander_id then
				return squad:commander_id()
			end
		end
	end

end

task_status_functor.raid_task_kill_strong_stalker_squad_status_functor = function(tsk,task_id)
	local active_t = raid_tasks_main.raid_active_tasks
	local cur_time = game.get_game_time()
	local task_data = raid_tasks_main.get_task_data(task_id)
	if not (task_data and tsk) then return end

	if not tsk.stage then
		tsk.stage = 0
	end

	if tsk.stage > 0 and not active_t[task_id] then
		return
	end

--[[
	0 = setup
	1 = spawn
	2 = watch when killed
	3 = all killed
--]]

	-- setup
	if tsk.stage == 0 then
		active_t[task_id] = {}

		-- store level name
		active_t[task_id].level_name = task_data.level_name

		-- get squad section
		local sec = task_data.kill_strong_stalker_squad_sec
		active_t[task_id].squad_sec = sec

		-- store non-busy and viable smart id
		local all_smarts_t = raid_utils.find_random_smart(task_data.level_name, true, "all")
		local comm = ini_sys:r_string_ex(sec, "faction")
		local smart = raid_utils.find_viable_smart(all_smarts_t, comm)
		local smart_id = smart.id
		active_t[task_id].smart_id = smart_id

		-- add smart id to busy smarts
		raid_tasks_main.raid_busy_smarts_t[smart_id] = true

		-- killed_by field
		active_t[task_id].killed = 0
		active_t[task_id].killed_by_actor = 0

		-- set timer
		active_t[task_id].start_time = ctime_to_t(cur_time)

		tsk.stage = 1
		return
	end


	-- spawn
	if tsk.stage == 1 and level.name() == active_t[task_id].level_name then
		local squad = raid_simulation.spawn_raid_sim_squad(active_t[task_id].smart_id, active_t[task_id].squad_sec)

		-- store squad id as a target and squad size
		if squad and squad.commander_id then
			active_t[task_id].strong_stalker_squad_id = squad.id
			active_t[task_id].squad_size = raid_utils.get_squad_size(squad.id)
		end

		tsk.stage = 2
		return
	end


	-- if all killed
	if tsk.stage == 2 and active_t[task_id].killed >= active_t[task_id].squad_size then
		-- if enough killed by us
		if active_t[task_id].killed_by_actor >= (active_t[task_id].squad_size * 0.6) then
			tsk.stage = 3
			return
		end

		-- not enough killed
		raid_tasks_main.end_raid_task(task_id, "cancel")
		return
	end


	-- return home with enough killed
	if tsk.stage == 3 then
		if level.name() == raid_utils.raid_home_level then
			raid_tasks_main.end_raid_task(task_id, "complete")
		end
		return
	end

	-- return home with not enough killed
	if tsk.stage == 2 and level.name() == raid_utils.raid_home_level then
		raid_tasks_main.end_raid_task(task_id, "fail")		-- xcvb reward argument here
		return
	end

	-- fail on timer
	if task_data.urgent < 4 then
		local hours = raid_tables.raid_urgency_time[task_data.urgent]
		if cur_time:diffSec(t_to_ctime(active_t[task_id].start_time)) > (hours * 3600) then
			raid_tasks_main.end_raid_task(task_id, "fail")
		end
	end

end


-- ============================================
-- =========== (5) Kill Strong Mutant squad =============
-- ============================================
task_functor.raid_task_kill_strong_mutant_squad_target_functor = function(task_id,field,p,tsk)
	local active_t = raid_tasks_main.raid_active_tasks
	local stage = tsk and tsk.stage

	if (field == "title") then
		return raid_utils.get_raid_task_title(task_id, stage, 3)
	elseif (field == "descr") then
		return raid_utils.get_raid_task_descr(task_id, stage, 3)
	elseif (field == "target") and stage and stage > 0 and active_t[task_id] then
		if tsk.stage == 2 then
			local squad = alife_object(active_t[task_id].strong_mutant_squad_id)
			if squad and squad.commander_id then
				return squad:commander_id()
			end
		end
	end

end

task_status_functor.raid_task_kill_strong_mutant_squad_status_functor = function(tsk,task_id)
	local active_t = raid_tasks_main.raid_active_tasks
	local cur_time = game.get_game_time()
	local task_data = raid_tasks_main.get_task_data(task_id)
	if not (task_data and tsk) then return end

	if not tsk.stage then
		tsk.stage = 0
	end

	if tsk.stage > 0 and not active_t[task_id] then
		return
	end

--[[
	0 = setup
	1 = spawn
	2 = watch when killed
	3 = all killed
--]]

	-- setup
	if tsk.stage == 0 then
		active_t[task_id] = {}

		-- store level name
		active_t[task_id].level_name = task_data.level_name

		-- get squad section
		local sec = task_data.kill_strong_mutant_squad_sec
		active_t[task_id].squad_sec = sec

		-- store non-busy and viable smart id
		local all_smarts_t = raid_utils.find_random_smart(task_data.level_name, true, "all")
		local smart = raid_utils.find_viable_smart(all_smarts_t, "monster")
		local smart_id = smart.id
		active_t[task_id].smart_id = smart_id

		-- add smart id to busy smarts
		raid_tasks_main.raid_busy_smarts_t[smart_id] = true

		-- killed_by field
		active_t[task_id].killed = 0
		active_t[task_id].killed_by_actor = 0

		-- set timer
		active_t[task_id].start_time = ctime_to_t(cur_time)

		tsk.stage = 1
		return
	end


	-- spawn
	if tsk.stage == 1 and level.name() == active_t[task_id].level_name then
		local squad = raid_simulation.spawn_raid_sim_squad(active_t[task_id].smart_id, active_t[task_id].squad_sec)

		-- store squad id as a target and squad size
		if squad and squad.commander_id then
			active_t[task_id].strong_mutant_squad_id = squad.id
			active_t[task_id].squad_size = raid_utils.get_squad_size(squad.id)
		end

		tsk.stage = 2
		return
	end


	-- if all killed
	if tsk.stage == 2 and active_t[task_id].killed >= active_t[task_id].squad_size then
		-- if enough killed by us
		if active_t[task_id].killed_by_actor >= (active_t[task_id].squad_size * 0.6) then
			tsk.stage = 3
			return
		end

		-- not enough killed
		raid_tasks_main.end_raid_task(task_id, "cancel")
		return
	end


	-- return home with enough killed
	if tsk.stage == 3 then
		if level.name() == raid_utils.raid_home_level then
			raid_tasks_main.end_raid_task(task_id, "complete")
		end
		return
	end

	-- return home with not enough killed
	if tsk.stage == 2 and level.name() == raid_utils.raid_home_level then
		raid_tasks_main.end_raid_task(task_id, "fail")		-- xcvb reward argument here
		return
	end

	-- fail on timer
	if task_data.urgent < 4 then
		local hours = raid_tables.raid_urgency_time[task_data.urgent]
		if cur_time:diffSec(t_to_ctime(active_t[task_id].start_time)) > (hours * 3600) then
			raid_tasks_main.end_raid_task(task_id, "fail")
		end
	end

end


-- ============================================
-- ============================================
function squad_on_npc_death(squad, se_obj, killer)
	local active_t = raid_tasks_main.raid_active_tasks
	for task_id, t in pairs(active_t) do

		-- kill stalker task
		if t.stalker_id and t.stalker_id == se_obj.id then
			if raid_utils.kill_task_cond(squad, se_obj, killer) then
				active_t[task_id].killed_by_actor = true
			end
			active_t[task_id].stalker_killed = true
		end

		-- kill stalker squad task
		if (t.stalker_squad_id and t.stalker_squad_id == squad.id)
		-- or kill mutant squad task
		or (t.mutant_squad_id and t.mutant_squad_id == squad.id)
		-- or kill strong stalker squad task
		or (t.strong_stalker_squad_id and t.strong_stalker_squad_id == squad.id)
		-- or kill strong mutant squad task
		or (t.strong_mutant_squad_id and t.strong_mutant_squad_id == squad.id)
		then
			if raid_utils.kill_task_cond(squad, se_obj, killer) then
				active_t[task_id].killed_by_actor = active_t[task_id].killed_by_actor + 1
			end
			active_t[task_id].killed = active_t[task_id].killed + 1
		end

	end
end

function on_game_start()
	RegisterScriptCallback("squad_on_npc_death", squad_on_npc_death)
end