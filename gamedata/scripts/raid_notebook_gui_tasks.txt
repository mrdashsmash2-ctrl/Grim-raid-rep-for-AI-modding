local gt = game.translate_string
local ltx = ini_file("misc\\task\\tm_raid_tasks.ltx")
local RaidNotebook = raid_notebook_gui.RaidNotebook


function RaidNotebook:BuildTaskMenu()
	local xml = self.xml

	self.task_menu_cont = xml:InitStatic("task_menu_cont", self.bg)
	self.task_menu_cont:Show(false)

	-- descr title
	self.task_header_cont = xml:InitStatic("task_menu_cont:header_cont", self.task_menu_cont)
	self.task_icon_header = xml:InitTextWnd("task_menu_cont:header_cont:icon_header", self.task_header_cont)
	self.task_descr_header = xml:InitTextWnd("task_menu_cont:header_cont:descr_header", self.task_header_cont)
	self.task_reward_header = xml:InitTextWnd("task_menu_cont:header_cont:reward_header", self.task_header_cont)

	-- tasks scroll
	self.task_scroll = xml:InitScrollView("task_menu_cont:tasks_scrollbar", self.task_menu_cont)

	-- scroll cont
	self.scroll_cont = xml:InitStatic("task_menu_cont:scroll_cont", self.task_scroll)
	self.scroll_cont:SetAutoDelete(false)

	-- placeholders for tasks
	self.task_cont_y_gap = 15
	local i = 0
	ltx:section_for_each(function(section)
		if (not string.find(section, "general")) then
			i = i + 1

			self.task_conts[i] = {}
			self.task_conts[i].task_sec = "nil"

			self.task_conts[i].main_cont = xml:InitStatic("task_menu_cont:task_cont", self.scroll_cont)

			-- adjust pos
			local pos = self.task_conts[i].main_cont:GetWndPos()
			local height = self.task_conts[i].main_cont:GetHeight()
			local y_gap = i <= 1 and 0 or self.task_cont_y_gap
			local new_y = (height + y_gap) * (i-1)
			self.task_conts[i].main_cont:SetWndPos(vector2():set(pos.x, new_y))

			self.task_conts[i].icon = xml:InitStatic("task_menu_cont:task_cont:icon", self.task_conts[i].main_cont)
			self.task_conts[i].reputation_cont = xml:InitStatic("task_menu_cont:task_cont:reputation_cont", self.task_conts[i].main_cont)
			self.task_conts[i].reputation_bar = xml:InitProgressBar("task_menu_cont:task_cont:reputation_cont:bar", self.task_conts[i].reputation_cont)
			self.task_conts[i].reputation_text = xml:InitTextWnd("task_menu_cont:task_cont:reputation_cont:bar_text", self.task_conts[i].reputation_cont)
			self.task_conts[i].descr = xml:InitStatic("task_menu_cont:task_cont:descr_cont", self.task_conts[i].main_cont)
			self.task_conts[i].reward = xml:InitStatic("task_menu_cont:task_cont:reward_cont", self.task_conts[i].main_cont)

			self.task_conts[i].details_hover = xml:Init3tButton("task_menu_cont:task_cont:details_hover", self.task_conts[i].main_cont)
			self.task_conts[i].accept_btn = xml:Init3tButton("task_menu_cont:task_cont:accept_btn", self.task_conts[i].main_cont)
			self:Register(self.task_conts[i].accept_btn, "task_accept_btn_" .. i)

			-- rep thresholds on bar
			self.task_conts[i].reputation_thresholds = {}
			for j = 1, 4 do
				self.task_conts[i].reputation_thresholds[j] = xml:InitStatic("task_menu_cont:task_cont:reputation_cont:rep_threshold_" .. j, self.task_conts[i].reputation_cont)
			end

		end
	end)

	-- tooltip
	self.task_tooltip.main = xml:InitStatic("task_menu_cont:task_tooltip_cont", self.task_menu_cont)
	self.task_tooltip.main:Show(false)

	self.task_tooltip.icon = xml:InitStatic("task_menu_cont:task_tooltip_cont:tooltip_icon", self.task_tooltip.main)
	self.task_tooltip.descr = xml:InitStatic("task_menu_cont:task_tooltip_cont:tooltip_descr", self.task_tooltip.main)
	self.task_tooltip.rep = xml:InitStatic("task_menu_cont:task_tooltip_cont:tooltip_rep", self.task_tooltip.main)
	self.task_tooltip.long_descr = xml:InitStatic("task_menu_cont:task_tooltip_cont:tooltip_long_descr", self.task_tooltip.main)

	self.task_tooltip.map = {}
	self.task_tooltip.map.main = xml:InitStatic("task_menu_cont:task_tooltip_cont:tooltip_map_cont", self.task_tooltip.main)
	self.task_tooltip.map.title = xml:InitStatic("task_menu_cont:task_tooltip_cont:tooltip_map_cont:map_title", self.task_tooltip.map.main)
	self.task_tooltip.map.map_cont = xml:InitStatic("task_menu_cont:task_tooltip_cont:tooltip_map_cont:map_cont", self.task_tooltip.map.main)
	self.task_tooltip.map.map = xml:InitStatic("task_menu_cont:task_tooltip_cont:tooltip_map_cont:map_cont:map_map", self.task_tooltip.map.map_cont)

	self.task_tooltip.reward = {}
	self.task_tooltip.reward.main = xml:InitStatic("task_menu_cont:task_tooltip_cont:tooltip_reward_cont", self.task_tooltip.main)
	self.task_tooltip.reward.rew_title = xml:InitStatic("task_menu_cont:task_tooltip_cont:tooltip_reward_cont:reward_title", self.task_tooltip.reward.main)
	self.task_tooltip.reward.reward = xml:InitStatic("task_menu_cont:task_tooltip_cont:tooltip_reward_cont:reward_reward", self.task_tooltip.reward.main)
	self.task_tooltip.reward.reward_text = xml:InitTextWnd("task_menu_cont:task_tooltip_cont:tooltip_reward_cont:reward_reward:reward_text", self.task_tooltip.reward.reward)
	self.task_tooltip.reward.pen_title = xml:InitStatic("task_menu_cont:task_tooltip_cont:tooltip_reward_cont:penalty_title", self.task_tooltip.reward.main)
	self.task_tooltip.reward.penalty = xml:InitStatic("task_menu_cont:task_tooltip_cont:tooltip_reward_cont:penalty_penalty", self.task_tooltip.reward.main)

	-- informator
	self.task_informator.header = xml:InitStatic("task_menu_cont:informant_btn_cont", self.task_menu_cont)
	self.task_informator.btn = xml:Init3tButton("task_menu_cont:informant_btn_cont:informant_btn", self.task_informator.header)
	self:Register(self.task_informator.btn, "task_informator_btn")

	self.task_informator.main = xml:InitStatic("task_menu_cont:informant_cont", self.task_menu_cont)
	raid_utils.align_element(self, self.task_informator.main, self.task_menu_cont, "c", "c")
	self.task_informator.main:Show(false)

	self.task_informator.close_btn = xml:Init3tButton("task_menu_cont:informant_cont:informant_close_btn", self.task_informator.main)
	self:Register(self.task_informator.close_btn, "task_informant_close")

	self.task_informator.opt = {}
	for i, t in ipairs(raid_notebook_gui.informant_options_ar) do
		self.task_informator.opt[i] = xml:Init3tButton("task_menu_cont:informant_cont:informant_opt_btn", self.task_informator.main)
		self:Register(self.task_informator.opt[i], "task_informator_opt_" .. i)

		local inf_str = ""
		if i == 1 then
			inf_str = string.format(gt(t.str), raid_tables.informant_bonus_tasks_amount, t.cost[raid_utils.get_actor_rank_name()])
		elseif i == 2 then
			inf_str = string.format(gt(t.str), raid_tables.informant_bonus_insurance_percent, t.cost[raid_utils.get_actor_rank_name()])
		elseif i == 3 then
			inf_str = string.format(gt(t.str), raid_tables.informant_bonus_raid_time, t.cost[raid_utils.get_actor_rank_name()])
		elseif t.str ~= "" then
			inf_str = gt(t.str)
		end
		self.task_informator.opt[i]:TextControl():SetText(inf_str)

		local inf_opt_pos, inf_opt_h = self.task_informator.opt[i]:GetWndPos(), self.task_informator.opt[i]:GetHeight()
	--	local new_y = i <= 1 and inf_opt_pos.y or (inf_opt_h * (i-1)) + (inf_opt_pos.y * i)
		local y_gap = 23
		local new_y = i <= 1 and inf_opt_pos.y or (inf_opt_pos.y) + (inf_opt_h * (i-1)) + (y_gap * (i-1))

		if i ~= 5 then
			self.task_informator.opt[i]:SetWndPos(vector2():set(inf_opt_pos.x, new_y))
		else		-- debug a bit upper to be able to click
			self.task_informator.opt[i]:SetWndPos(vector2():set(inf_opt_pos.x, new_y-y_gap))
		end
	end
end

function RaidNotebook:UpdateTaskMenu()
	local xml = self.xml

	-- hide all task containers
	for i = 1, #self.task_conts do
		self.task_conts[i].main_cont:Show(false)
	end

	-- fill tasks
	local scroll_cont_height_mult = 0
	for comm, t in pairs(raid_tasks_main.raid_tasks_t) do
		for sec, task_t in pairs(t.tasks) do
			if (not task_t.active) then

				scroll_cont_height_mult = scroll_cont_height_mult + 1

				-- order index
				local i = task_t.gui_index

				-- show this container
				self.task_conts[i].main_cont:Show(true)

				-- icon
				local npc_name = gt(t.name) or ""
				self.task_conts[i].icon:TextControl():SetText(npc_name)
				self.task_conts[i].icon:InitTexture(t.icon)

				-- goodwill
				self.task_conts[i].reputation_bar:SetProgressPos(t.goodwill / raid_tables.max_goodwill)
				self.task_conts[i].reputation_text:SetText(t.goodwill .. " / " .. raid_tables.max_goodwill)

				-- goodwill thresholds
				local gw_ar = { 400, 600, 800, 1000 }
				for j = 1, 4 do
					if comm ~= "other" then
						local thresh_clr = t.goodwill >= gw_ar[j] and GetARGB(120, 40, 255, 20) or GetARGB(120, 255, 255, 0)
						self.task_conts[i].reputation_thresholds[j]:SetTextureColor( thresh_clr )
					end
				end

				-- descr
				local task_tier_s = gt("st_raid_task_title_tier") .. " " .. task_t.tier .. "\\n \\n"
				local urgency_s = gt("st_raid_task_title_urgency") .. " " .. string.format(gt("st_raid_task_urgency_" .. task_t.urgent), raid_tables.raid_urgency_time[task_t.urgent]) .. "\\n \\n"
				local level_name_s = task_t.level_name ~= "nil" and (gt("st_raid_task_title_level") .. " " .. gt(task_t.level_name)) .. "\\n \\n" or ""
				local task_type_s = gt("st_raid_task_title_type") .. " " .. gt("st_raid_task_" .. task_t.typ) .. raid_utils.get_translated_group_string(task_t.group, task_t.typ)
				local descr_str = task_tier_s .. urgency_s .. level_name_s .. task_type_s
				self.task_conts[i].descr:TextControl():SetText(descr_str)

				-- reward
				local reward_str = ""
				if task_t.reward then
					local items_str = raid_utils.get_reward_items_string(task_t.reward.items, true)
					local goodwill_penalties_str = task_t.reward.goodwill_penalty and (" \\n" .. gt("st_raid_task_title_reward_goodwill_penalty") .. "   " .. task_t.reward.goodwill_penalty) or ""
					reward_str = gt("st_raid_task_title_reward_money") .. "   " .. task_t.reward.money .. " " .. gt("st_rubles") .. "" .. items_str .. " \\n \\n" .. gt("st_raid_task_title_reward_rank") .. "   " .. task_t.reward.rank .. " \\n \\n" .. gt("st_raid_task_title_reward_goodwill") .. "   " .. task_t.reward.goodwill .. goodwill_penalties_str
				elseif task_t.special_reward_mult then
					local mult_str = task_t.special_reward_mult ~= 1 and (" * " .. task_t.special_reward_mult) or ""
					reward_str = gt("st_raid_task_title_reward_money") .. "   " .. gt("st_raid_task_title_reward_cost") .. mult_str
				end
				self.task_conts[i].reward:TextControl():SetText(reward_str)

				-- tie section to this button index
				self.task_conts[i].task_sec = sec

			end
		end
	end


	-- resize scroll cont
	local task_cont_height = self.task_conts[1].main_cont:GetHeight()
	local scroll_cont_width = self.scroll_cont:GetWidth()
	self.scroll_cont:SetWndSize(vector2():set(scroll_cont_width, scroll_cont_height_mult * (task_cont_height + self.task_cont_y_gap) ))

	-- add container to scroll
	self.task_scroll:Clear()
	self.task_scroll:AddWindow(self.scroll_cont, true)
	self.scroll_cont:SetAutoDelete(false)

end

function RaidNotebook:OnAcceptTask(i)
	local section = self.task_conts[i].task_sec

	if not ltx:section_exist(section) then
		printf("! Task section: [%s] does not exist", section)
		return
	end

	for comm, t in pairs(raid_tasks_main.raid_tasks_t) do
		if t.tasks[section] and (not t.tasks[section].active) then

			-- give task
			printf("- [%s] task given", section)
			task_manager.get_task_manager():give_task(section)

			-- make it active
			raid_tasks_main.raid_tasks_t[comm]["tasks"][section].active = true

			-- adjust gui order for other tasks (not to get random orders every time)
			local cur_gui_index = t.tasks[section].gui_index
			for k, v in pairs(raid_tasks_main.raid_tasks_t) do
				for s, v2 in pairs(v.tasks) do
					if s ~= section and v2.gui_index > cur_gui_index then
						raid_tasks_main.raid_tasks_t[k]["tasks"][s].gui_index = v2.gui_index - 1
					end
				end
			end

			-- update tasks menu
			local scroll_pos = self.task_scroll:GetCurrentScrollPos()			
			self:UpdateTaskMenu()
			self.task_scroll:SetScrollPos(scroll_pos)
			return
		end
	end
end

function RaidNotebook:FillTooltip(idx)
	local gui_task_sec = self.task_conts[idx].task_sec

	for comm, t in pairs(raid_tasks_main.raid_tasks_t) do
		local task_t = t.tasks[gui_task_sec]
		if task_t then

			-- icon
			self.task_tooltip.icon:InitTexture(t.icon)

			-- descr
			local task_tier_s = gt("st_raid_task_title_tier") .. " " .. task_t.tier .. "\\n"
			local urgency_s = gt("st_raid_task_title_urgency") .. " " .. string.format(gt("st_raid_task_urgency_" .. task_t.urgent), raid_tables.raid_urgency_time[task_t.urgent]) .. "\\n"
			local level_name_s = task_t.level_name ~= "nil" and (gt("st_raid_task_title_level") .. " " .. gt(task_t.level_name)) .. "\\n" or ""
			local task_type_s = gt("st_raid_task_title_type") .. " " .. gt("st_raid_task_" .. task_t.typ) .. raid_utils.get_translated_group_string(task_t.group, task_t.typ)
			local descr_str = task_tier_s .. urgency_s .. level_name_s .. task_type_s
			self.task_tooltip.descr:TextControl():SetText(descr_str)

			-- goodwill
			self.task_tooltip.rep:TextControl():SetText(t.goodwill .. " / " .. raid_tables.max_goodwill)

			-- long descr
			self.task_tooltip.long_descr:TextControl():SetText(strformat(gt("st_raid_task_" .. task_t.typ .. "_" .. comm .. "_descr"), alife():actor():character_name()))

			-- map
			if task_t.level_name ~= "nil" then
				local cont_w, cont_h = self.task_tooltip.map.map_cont:GetWidth(), self.task_tooltip.map.map_cont:GetHeight()
				if raid_notebook_gui.tooltip_maps_width[task_t.level_name] then
					cont_w = cont_w * raid_notebook_gui.tooltip_maps_width[task_t.level_name]
				end
				self.task_tooltip.map.title:TextControl():SetText(gt("st_raid_task_title_level") .. " \\n" .. gt(task_t.level_name))
				self.task_tooltip.map.map:SetWndSize(vector2():set(cont_w, cont_h))
				self.task_tooltip.map.map:InitTexture("raid_map_" .. task_t.level_name)
				raid_utils.align_element(self, self.task_tooltip.map.map, self.task_tooltip.map.map_cont, "c", "c")
			else
				self.task_tooltip.map.title:TextControl():SetText("")
				self.task_tooltip.map.map:SetWndSize(vector2():set(0, 0))
				self.task_tooltip.map.map:InitTexture("none.dds")
			end

			-- reward
			local reward_str = ""
			if task_t.reward then
				local items_str = raid_utils.get_reward_items_string(task_t.reward.items, nil, true)
				local goodwill_penalties_str = task_t.reward.goodwill_penalty and (" \\n" .. gt("st_raid_task_title_reward_goodwill_penalty") .. "   " .. task_t.reward.goodwill_penalty) or ""
				reward_str = gt("st_raid_task_title_reward_money") .. "   " .. task_t.reward.money .. " " .. gt("st_rubles") .. items_str .. " \\n" .. gt("st_raid_task_title_reward_rank") .. "   " .. task_t.reward.rank .. " \\n" .. gt("st_raid_task_title_reward_goodwill") .. "   " .. task_t.reward.goodwill .. goodwill_penalties_str
			elseif task_t.special_reward_mult then
				local mult_str = task_t.special_reward_mult ~= 1 and (" * " .. task_t.special_reward_mult) or ""
				reward_str = gt("st_raid_task_title_reward_money") .. "   " .. gt("st_raid_task_title_reward_cost") .. mult_str
			end
			self.task_tooltip.reward.reward_text:SetText(reward_str)

			-- penalties
			local num = raid_tables.base_task_fail_goodwill
			if (string.find(gui_task_sec, "_find_")) then num = raid_tables.base_task_find_fail_goodwill end
			local penalty_str = gt("st_raid_task_title_reward_goodwill") .. "   " .. num
			self.task_tooltip.reward.penalty:TextControl():SetText(penalty_str)

		end
	end

end