-- trx_paid_companions.script changed
-- я предлагал тоже самое, но в 10 раз легче
-- автору идеи надо, чтобы именно так было, дальше вот и ибитесь сами ;]

local rank_mult_t = {
	novice = 1, trainee = 1,
	experienced = 2, professional = 2,
	veteran = 3, expert = 3,
	master = 4, legend = 4,
}

local raid_comp_timer
local ctime_to_t = utils_data.CTime_to_table
local t_to_ctime = utils_data.CTime_from_table
local fa_list = { "stalker" }

local tmr = 0
function actor_on_update()
	local tg = time_global()
	if tmr > tg then return end
	tmr = tg + 10000

	local cur_time = game.get_game_time()

	if (not raid_comp_timer) or (cur_time:diffSec(t_to_ctime(raid_comp_timer)) > (24*3600)) then
		local smart = SIMBOARD.smarts_by_names["rad2_prip_teleport"]
		if smart and db.actor:position():distance_to(smart.position) > 50 then
			raid_comp_timer = ctime_to_t(cur_time)

			release_comp_squad()
			if math.random() < 0.05 then return end

			if raid_tasks_main.raid_tasks_t["stalker"].goodwill >= 150 then table.insert(fa_list, "csky") end
			if raid_tasks_main.raid_tasks_t["duty"].goodwill >= 300 then table.insert(fa_list, "duty") end
			if raid_tasks_main.raid_tasks_t["freedom"].goodwill >= 200 then table.insert(fa_list, "freedom") end
			if raid_tasks_main.raid_tasks_t["ecolog"].goodwill >= 400 then table.insert(fa_list, "ecolog") end
			
			local temp_fa = fa_list[math.random(1, #fa_list)]
			if string.find(temp_fa, "duty") then remove_faction("freedom") end
			if string.find(temp_fa, "freedom") then remove_faction("duty") end

			local actor_rank = raid_utils.get_actor_rank_name()
			local rank_mult = actor_rank and rank_mult_t[actor_rank]
			local rank_chance = rank_mult * 0.2
			spawn_comp_squad("raid_"..temp_fa.."_sim_squad_", rank_mult)						
			if rank_chance and math.random() < rank_chance then
				local temp_rank = math.random(1, rank_mult) + math.random(-1, 1)
				spawn_comp_squad("raid_"..fa_list[math.random(1, #fa_list)].."_sim_squad_", clamp(temp_rank, 1, 4))
			end
		end
	end
end

function remove_faction(faction)
	for i = #fa_list, 1, -1 do
		if fa_list[i] == faction then
			table.remove(fa_list, i)
		end
	end
end

function spawn_comp_squad(sec1, sec2)
	if sec2 == 1 and (not (string.find(sec1, "stalker") or string.find(sec1, "ecolog"))) then
		sec2 = sec2 + 1
	end
	
	local smart = SIMBOARD.smarts_by_names["rad2_prip_teleport"]
	local squad = SIMBOARD:create_squad(smart, sec1..sec2)
	if squad and squad.commander_id then
		squad:specific_update(smart.id)
	end
end

function release_comp_squad()
	local rel_list = { "stalker", "csky", "duty", "freedom", "ecolog" }
	for id,_ in pairs(SIMBOARD.squads) do
		local squad = alife_object(id)
		if squad and alife():level_name(game_graph():vertex(squad.m_game_vertex_id):level_id()) == "l10_radar" then
			for i = 1, #rel_list do
				if (string.find(squad:section_name(), "raid_"..rel_list[i].."_sim_squad_")) then
					alife():object(id):remove_squad()
				end
			end
		end
	end
end

function squad_on_first_update(squad)
	local lid = squad and game_graph():vertex(squad.m_game_vertex_id):level_id()
	local lname = lid and alife():level_name(lid)
	if lname and lname == raid_utils.raid_home_level and string.find(squad:section_name(), "sim_squad") then
		local smart = SIMBOARD.smarts_by_names["rad2_prip_teleport"]
		if smart then
			squad:specific_update(smart.id)
		end
	end
end

function save_state(m_data)
	m_data.raid_comp_timer = raid_comp_timer
end

function load_state(m_data)
	raid_comp_timer = m_data.raid_comp_timer or nil
end

function on_game_start()
	RegisterScriptCallback("actor_on_update", actor_on_update)
	RegisterScriptCallback("squad_on_first_update", squad_on_first_update)
	RegisterScriptCallback("save_state", save_state)
	RegisterScriptCallback("load_state", load_state)
end